function Resource(name, abundance, price) {
  return {
	qty: 0,
	price: price,
	name: name,
	abundance: abundance
  }
}

var game = {
  upgradeButton: document.createElement ("button"),
  sellButton: document.createElement ("button"),
  autoclickButton: document.createElement ("button"),
  CPCMeter: document.createElement ("p"),
  moneyMeter: document.createElement ("p"),
  resDisplay: {

  },

  res: {
	anthracite: Resource("anthracite", 0.5, 1),
	malachite: Resource("malachite", 0.3, 2),
	ferrite: Resource("ferrite", 0.2, 3)
  },
  money: 0,

  click_base: 10,
  click_level: 0,
  click_pow: 1.1,
  click_cost_pow: 1.2,
  click_cost_base: 100,
  autoclickers: 0,
  autoclick_cost_pow: 1.5,
  autoclick_cost_base: 1000
};

function formatMass(qty) {
  var unitList = ["g", "kg", "t", "kt", "Mt", "Gt", "Tt"];
  var unitIndex = Math.floor(Math.log10(qty) / 3);
  var unit = unitList[unitIndex];
  return (qty / Math.pow(10, unitIndex * 3)).toFixed(2) + "&nbsp;" + unit;
}

function formatMoney(qty) {
  if (qty <= 0) {
	return "0&nbsp;&euro;";
  }
  var prefixList = ["", "k", "M", "G", "T"];
  var prefixIndex = Math.floor(Math.log10(qty) / 3);
  var prefix = prefixList[prefixIndex];
  return (qty / Math.pow(10, prefixIndex * 3)).toFixed(2) + "&nbsp;" + prefix + "&euro;";
}

function updateResourceDisplay() {
  for (var res in game.res) {
	if (game.res[res].qty <= 0) {
	  game.resDisplay[res].style.display = "none";
	} else {
	  game.resDisplay[res].style.display = "block";
	}
	game.resDisplay[res].innerHTML = game.res[res].name + ": " + formatMass(game.res[res].qty);
  }
  game.moneyMeter.innerHTML = formatMoney(game.money);
  game.CPCMeter.innerHTML = "Resources per click: " + getResPerClick();
  game.upgradeButton.innerHTML = "Upgrade resources per click: " + formatMoney(getUpdateCost());
  game.autoclickButton.innerHTML = "Buy an autoclicker: " + formatMoney(getAutoclickCost());
}

function getResPerClick() {
  return Math.floor(game.click_base * Math.pow(game.click_pow, game.click_level));
}

function getUpdateCost() {
  return Math.floor(game.click_cost_base * Math.pow(game.click_cost_pow, game.click_level));
}

function getAutoclickCost() {
  return game.autoclick_cost_base * Math.pow(game.autoclick_cost_pow, game.autoclickers);
}

function click (n) {
  // Also update the text labels.
  for (var res in game.res) {
	game.res[res].qty += n * Math.round(getResPerClick() * game.res[res].abundance);
  }
  updateResourceDisplay();
}

function upgrade () {
  if (game.money >= getUpdateCost()) {
	game.money -= getUpdateCost();
	game.click_level += 1;
  }
  updateResourceDisplay();
}

function buyAutoclick() {
  if (game.money >= getAutoclickCost()) {
	game.money -= getAutoclickCost();
	++game.autoclickers;
  }
}

function sell () {
  for (var res in game.res) {
	game.money += game.res[res].qty * game.res[res].price;
	game.res[res].qty = 0;
  }
  updateResourceDisplay();
}

function start () {
  // The actual clicker part.
  for (var res in game.res) {
	game.resDisplay[res] = document.createElement ("p");
  }
  game.sellButton.innerHTML = "sell";
  document.getElementById("buttons").appendChild (game.upgradeButton);
  document.getElementById("buttons").appendChild (game.autoclickButton);
  document.getElementById("buttons").appendChild (game.sellButton);
  document.getElementById("rock-button").onclick = function () { click(1); };
  game.sellButton.onclick = sell;
  game.upgradeButton.onclick = upgrade;
  game.autoclickButton.onclick = buyAutoclick;

  // Displays.
  document.body.appendChild (game.moneyMeter);
  document.getElementById("money-display").appendChild (game.moneyMeter);
  for (var res in game.res) {
	document.getElementById("resource-display").appendChild (game.resDisplay[res]);
  }

  // Upgrades.
  updateResourceDisplay();
  setInterval(function() { click(game.autoclickers);}, 200);
}
